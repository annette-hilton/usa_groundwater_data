---
title: "Confined vs Unconfined Aquifer Analysis"
author: "Annette Hilton"
date: "2/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, error = FALSE)
```
## Introduction 

This Rmd document explores confined and unconfined aquifers in the Mississippi Embayment. Is there a difference between water levels over time in confined vs. unconfined aquifers? 

## Obtaining Data 

### USGS ME Geologic Data 

USGS Mississippi Embayment (ME) geologic data was obtained through the following process: 

- Main page: https://pubs.usgs.gov/sir/2008/5098/
- Second page: https://pubs.usgs.gov/sir/2008/5098/downloads/
- Download page: https://pubs.usgs.gov/sir/2008/5098/downloads/WRD_NSDI_Node.html
  - Download "Hydrologic Model Layer Surfaces" **raster** file
  
### USGS ME Topography Data 

USGS ME topography data was obtained through the following process: 

- Main page: https://www.usgs.gov/core-science-systems/national-geospatial-program/national-map
- Download and Selection page: https://viewer.nationalmap.gov/basic/?basemap=b1&category=ned,nedsrc&title=3DEP%20View
  - Steps: 
  - Create a box/narrow the view to your area of interest
  - 


## Attach Packages and Data 

```{r}
# Attach packages 

library(tidyverse)
library(here)
library(janitor)
library(naniar)
library(plyr)

# Disable scientific notation 

options(scipen=999)
```

```{r}
# Read in the full dataset for all well water measurements for the USA 

entire_usa_gw <- readr::read_tsv("entire_usgs_usa.txt")
```

## R Data Analysis 

### Refine dataset for the Mississippi Embayment 

```{r}
# Only keep well data for states in ME: 
# Missouri, Illinois, Kentucky, Tennessee, Arkansas, Mississippi, Alabama, Louisiana

me <- entire_usa_gw %>% 
  filter(state %in% c("alabama", "arkansas", "illinois", "kentucky", "louisiana", "missouri", "mississippi", "tennessee"))

# If-else statement to have either well_depth or hole_depth (OR) 
# Remove well depths of 0
# Remove wells that do not have a date associated with them 

me_usgs_gw <- me %>% 
  filter(!well_depth_va == "NA" | !hole_depth_va == "NA") %>% 
  filter(!well_depth_va == 0.00) %>% 
  filter(!lev_dt == "NA")

```


### Create experimental subset of data to try date constraint on (just Alabama)

```{r}
# Only keep alabama 

exp_sub <- me_usgs_gw %>% 
  filter(state == "alabama") 
  
```

```{r}
# Determine min/max dates of wells (unique wells) 
# Group by site_no and have minimum of 9 observations for each well 
# use summarise to find min and max date 

sub_minmax <- exp_sub %>%
  group_by(site_no) %>%
  filter(n() > 9) %>%
  dplyr::summarise(
    mindate = min(level_year),
    maxdate = max(level_year)
  )

# Constrain by a range of 20 years

sub_date <- sub_minmax %>%
  filter(maxdate - mindate >= 20)
#
```

```{r}
# Make vector of unique site IDs that are constrained

constrained_wells <- sub_date %>%
  pull(site_no)

# Use the resulting vector to filter target sites from original dataframe

final_alabama_wells <- exp_sub %>%
  filter(site_no %in% c(constrained_wells))
```


### Use above method on entire dataset 

```{r}
# Determine min/max dates of wells (unique wells) 
# Group by site_no and have minimum of 9 observations for each well 
# use summarise to find min and max date 

me_minmax <- me_usgs_gw %>%
  group_by(site_no) %>% 
  filter(n() > 9) %>% 
  dplyr::summarise(
    mindate = min(level_year), 
    maxdate = max(level_year)
  )

# Constrain by a range of 20 years 

me_date <- me_minmax %>% 
  filter(maxdate - mindate >= 20)

# Make vector of unique site IDs that are constrained 

constrained_me_wells <- me_date %>% 
  pull(site_no)

# Use the resulting vector to filter target sites from original dataframe 

final_me_wells <- me_usgs_gw %>%
  filter(site_no %in% c(constrained_me_wells))

# Use just unique wells for location/ArcGIS purposes (added well and hole depth)

unique_me_wells <- final_me_wells %>% 
 distinct(site_no, .keep_all = TRUE) %>% 
  select(site_no, dec_lat_va, dec_long_va, well_depth_va, hole_depth_va, alt_va) 

# Test for ArcGIS issue (adding area column)

# unique_me_wells_2 <- final_me_wells %>% 
#  distinct(site_no, .keep_all = TRUE) %>% 
#   select(site_no, dec_lat_va, dec_long_va, well_depth_va, hole_depth_va) %>% 
#   mutate(area = "5")

# Add character value in front of site_no column as workaround for ArcGIS issue
# unique_me_wells$site_no <- sub("^", "x", unique_me_wells$site_no)

# Write to text file to then export to ArcGIS 

write_tsv(unique_me_wells, here::here("me_data", "unique_me_wells.txt"))

write_tsv(unique_me_wells, here::here("me_data", "unique_me_wells_2.txt"))
```

## ArcGIS Data Analysis 

The following steps were performed in ArcGIS: 

Hydrogeological data: 
Arcfile = "miss_embayment" 

1. Import USGS ME geologic data (rasters) 
2. Import USGS wells (text file from analysis above) 
3. Use tool "Extract multi values to points" to determine well location intersection with geological raster layers 
4. Create polygon to outline ME 
5. Use "Intersect" tool to constrain wells to only fall within the ME 
6. Export resulting well data (with intersection from step 3) as a text file 

Topography data: 
Arcfile = "me_top_extract"

1. Repeat steps 4-5 above (use polygon and constrain wells only to ME)
2. Use tool "Extract values to points" to determine well location intersection with topography rasters 
  - Must use this tool as the multi-value tool did not work; therefore extract 59 individual files 
3. Export resulting well data (59 individual files) as text files 

### Hydrogeological data & Topography data 

After processing in ArcGIS, import resulting text files (59 files) into R for further analysis 

```{r,  = FALSE}
# Read in files from ArcGIS 
# Create path of all 59 topography files 

topo_files = list.files(path = here::here("me_data", "topography"), pattern = "*.txt", full.names = TRUE)

# Read in all topography files into one dataframe 
topo_all = ldply(topo_files, read_csv)

```

Tidy data 

```{r}
# Basic data tidying 
# Create `na_strings` to indicate pesky NA values
# clean names, remove extra columns, remove character from site ID column 
# Replace NA numeric indicators with "NA" 

na_strings <- c("-9999", "-9999.00", "-9999.000", "-9999.0000", "-9999.00000", "-9999.000000")

me_wells_arc_tidy <- topo_all %>% 
  clean_names() %>% 
  select(-objectid_12, -objectid_1, -fid_wellsm, -objectid, -fid_mepoly, -shape_leng) %>% 
  replace_with_na_all(condition = ~.x %in% na_strings)

me_wells_arc_tidy$site_no <- gsub("x", "", me_wells_arc_tidy$site_no)

```

Join result file from ArcGIS with original unique well file to have all information in one dataframe 

```{r}
# First change class of me_wells_arc_tidy column site_no to numeric 

me_wells_arc_tidy$site_no <- as.numeric(me_wells_arc_tidy$site_no)

# Use inner_join() to merge dataframes 

arc_join_me <- unique_me_wells %>% 
  inner_join(me_wells_arc_tidy, by = "site_no")

# Tidy resulting dataframe 
# Remove excess columns and reorder based on geologic unit order (depth)

arc_join_me_tidy <- arc_join_me %>% 
  select(-dec_lat_va.y, -dec_long_v, -lcaq_sur_1) %>% 
  select(site_no, dec_lat_va.x, dec_long_va, well_depth_va, hole_depth_va, alt_va, vkbg_surf, ucaq_surf, mccu_surf, mcaq_surf, lccu_surf, lcaq_surf, mwaq_surf, lwaq_surf, mdwy_surf, rastervalu)


```

### ME Aquifer Information 

Hydrologic Model Layer Surfaces:

- Vicksburg-Jackson Group (top) **(vkbg)**   
- Upper Claiborne aquifer (top) **(ucaq)**
- Middle Claiborne confining unit (top) **(mccu)**  
- Middle Claiborne aquifer (top) **(mcaq)** 
- Lower Claiborne confining unit (top) **(lccu)**  
- Lower Claiborne aquifer (top) **(lcaq)** 
- Middle Wilcox aquifer (top) **(mwaq)**
- Lower Wilcox aquifer (top) **(lwaq)**
- Midway confining unit (top) **(mdwy)** 

Unit Range (ft): 

- vkbg: 566 (-364) 
- ucaq: 521 (-874)
- mccu: 540 (-1461)
- mcaq: 654 (-1659)
- lccu: 614 (-2539)
- lcaq: 616 (-3102)
- mwaq: 632 (-3347)
- lwaq: 555 (-2320)
- mdwy: 553 (-6036)

Confined vs Unconfined: 

- vkbg: confined  
- ucaq: unconfined
- mccu: confined
- mcaq: unconfined
- lccu: confined
- lcaq: unconfined
- mwaq: unconfined
- lwaq: unconfined
- mdwy: confined 

### Aquifer analysis 

Begin analysis of joined dataframe (find well bottom)

```{r}
# Convert `rastervalu` column from meters to feet (conversion: 1 meter = 3.28084 feet)
# Add a column that is elevation minus well depth

me_analysis <- arc_join_me_tidy %>% 
  mutate(topo_ft = rastervalu * 3.28084) %>% 
  mutate(well_bottom = topo_ft - well_depth_va)

```

#### Determine aquifer for each well  

Process: 

If well bottom is greater than second unit (top), then it falls within the first unit (second unit top is the bottom of the first unit). 

well bottom > ucaq (second unit) = vkbg (first unit) 
well bottom > mccu (third unit) = ucaq (second unit) 
well bottom > mcaq (fourth unit) = mccu (third unit) 
well bottom > lccu (fifth unit) = mcaq (fourth unit) 
well bottom > lcaq (sixth unit) = lccu (fifth unit) 
well bottom > mwaq (seventh unit) = lcaq (sixth unit) 
well bottom > lwaq (eigth unit) = mwaq (seventh unit) 
well bottom > mdwy (ninth unit) = lwaq (eigth unit) 
well bottom < mdwy (ninth unit) = mdwy (ninth unit) 

```{r}
# Determine which aquifer well_bottom falls within using `case_when()` 

me_aquifer <- me_analysis %>% 
  mutate(
    aquifer = case_when(
      well_bottom > ucaq_surf ~"vkbg", 
      well_bottom > mccu_surf ~"ucaq", 
      well_bottom > mcaq_surf ~"mccu", 
      well_bottom > lccu_surf ~"mcaq", 
      well_bottom > lcaq_surf ~"lccu", 
      well_bottom > mwaq_surf ~"lcaq", 
      well_bottom > lwaq_surf ~"mwaq", 
      well_bottom > mdwy_surf ~"lwaq", 
      well_bottom < mdwy_surf ~"mdwy")) 
```


```{r}
# Test for finding which aquifer well_bottom falls within using `ifelse()` 

# Only partially worked, commented out

# me_test <- me_analysis %>% 
#   mutate(aquifer = ifelse(well_bottom > ucaq_surf, "vkbg", "NA"), 
#          ifelse(well_bottom > mccu_surf, "ucaq", "NA"), 
#          ifelse(well_bottom > mcaq_surf, "mccu", "NA"), 
#          ifelse(well_bottom > lccu_surf, "mcaq", "NA"), 
#          ifelse(well_bottom > lcaq_surf, "lccu", "NA"), 
#          ifelse(well_bottom > mwaq_surf, "lcaq", "NA"), 
#          ifelse(well_bottom > lwaq_surf, "mwaq", "NA"), 
#          ifelse(well_bottom > mdwy_surf, "lwaq", "NA"), 
#          ifelse(well_bottom < mdwy_surf, "mdwy", "NA"))


```

#### Separate each aquifer/unit and confined vs unconfined 

Confined & Unconfined 

```{r}
# Confined aquifer units: vkbg, mccu, lccu, mdwy 

confined <- me_aquifer %>% 
  filter(aquifer %in% c("vkbg", "mccu", "lccu", "mdwy"))

# Unconfined aquifer units: ucaq, mcaq, lcaq, mwaq, lwaq

unconfined <- me_aquifer %>% 
  filter(aquifer %in% c("ucaq", "mcaq", "lcaq", "mwaq", "lwaq"))
```


Each aquifer unit 

```{r}
# vkbg 
vkbg <- me_aquifer %>% 
  filter(aquifer == "vkbg")

# ucaq
ucaq <- me_aquifer %>% 
  filter(aquifer == "ucaq")

# mccu
mccu <- me_aquifer %>% 
  filter(aquifer == "mccu")

# mcaq
mcaq <- me_aquifer %>% 
  filter(aquifer == "mcaq")

# lccu
lccu <- me_aquifer %>% 
  filter(aquifer == "lccu")

# lcaq
lcaq <- me_aquifer %>% 
  filter(aquifer == "lcaq")

# mwaq
mwaq <- me_aquifer %>% 
  filter(aquifer == "mwaq")

# lwaq
lwaq <- me_aquifer %>% 
  filter(aquifer == "lwaq")

# mdwy
mdwy <- me_aquifer %>% 
  filter(aquifer == "mdwy")

```

#### Return all observations for wells back into dataframes 

Create vector from wells with site ID only for each category (confined/unconfined; all units)

```{r}
# Create vector from wells with site ID only 

# Confined 
confined_vector <- confined %>% 
  pull(site_no)

# Unconfined 
unconfined_vector <- unconfined %>% 
  pull(site_no)

# vkbg
vkbg_vector <- vkbg %>% 
  pull(site_no)

# ucaq
ucaq_vector <- ucaq %>% 
  pull(site_no)

# mccu
mccu_vector <- mccu %>% 
  pull(site_no)

# mcaq
mcaq_vector <- mcaq %>% 
  pull(site_no)

# lccu
lccu_vector <- lccu %>% 
  pull(site_no)

# lcaq
lcaq_vector <- lcaq %>% 
  pull(site_no)

# mwaq
mwaq_vector <- mwaq %>% 
  pull(site_no)

# lwaq
lwaq_vector <- lwaq %>% 
  pull(site_no)

# mdwy
mdwy_vector <- mdwy %>% 
  pull(site_no)
  
```

Use vector to filter specific wells from larger dataframe of all ME wells & tidying 

```{r}
# Confined 
confined_all <- me_usgs_gw %>%
  filter(site_no %in% c(confined_vector)) %>% 
  mutate(type = "confined")

# Unconfined 
unconfined_all <- me_usgs_gw %>%
  filter(site_no %in% c(unconfined_vector)) %>% 
  mutate(type = "unconfined")

# vkbg
vkbg_all <- me_usgs_gw %>%
  filter(site_no %in% c(vkbg_vector)) %>% 
  mutate(type = "confined") %>% 
  mutate(unit = "vkbg")

# ucaq
ucaq_all <- me_usgs_gw %>%
  filter(site_no %in% c(ucaq_vector)) %>% 
  mutate(type = "unconfined") %>% 
  mutate(unit = "ucaq")

# mccu
mccu_all <- me_usgs_gw %>%
  filter(site_no %in% c(mccu_vector)) %>% 
  mutate(type = "confined") %>% 
  mutate(unit = "mccu")

# mcaq
mcaq_all <- me_usgs_gw %>%
  filter(site_no %in% c(mcaq_vector)) %>% 
  mutate(type = "unconfined") %>% 
  mutate(unit = "mcaq")

# lccu
lccu_all <- me_usgs_gw %>%
  filter(site_no %in% c(lccu_vector)) %>% 
  mutate(type = "confined") %>% 
  mutate(unit = "lccu")

# lcaq
lcaq_all <- me_usgs_gw %>%
  filter(site_no %in% c(lcaq_vector)) %>% 
  mutate(type = "unconfined") %>% 
  mutate(unit = "lcaq")

# mwaq
mwaq_all <- me_usgs_gw %>%
  filter(site_no %in% c(mwaq_vector)) %>% 
  mutate(type = "unconfined") %>% 
  mutate(unit = "mwaq")

# lwaq
lwaq_all <- me_usgs_gw %>%
  filter(site_no %in% c(lwaq_vector)) %>% 
  mutate(type = "unconfined") %>% 
  mutate(unit = "lwaq")

# mdwy
mdwy_all <- me_usgs_gw %>%
  filter(site_no %in% c(mdwy_vector)) %>% 
  mutate(type = "confined") %>% 
  mutate(unit = "mdwy")
```

Join all units for one giant dataframe 

```{r}
# Use `rbind()` to combine all units to one dataframe (combine vertically) 

all_aquifers <- rbind(vkbg_all, ucaq_all, mccu_all, mcaq_all, lccu_all, lcaq_all, mwaq_all, lwaq_all, mdwy_all)
```

