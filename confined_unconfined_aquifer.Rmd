---
title: "Confined vs Unconfined Aquifer Analysis"
author: "Annette Hilton"
date: "2/12/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## Introduction 

This Rmd document explores confined and unconfined aquifers in the Mississippi Embayment. Is there a difference between water levels over time in confined vs. unconfined aquifers? 

## Obtaining Data 

### USGS ME Geologic Data 

USGS Mississippi Embayment (ME) geologic data was obtained through the following process: 

- Main page: https://pubs.usgs.gov/sir/2008/5098/
- Second page: https://pubs.usgs.gov/sir/2008/5098/downloads/
- Download page: https://pubs.usgs.gov/sir/2008/5098/downloads/WRD_NSDI_Node.html
  - Download "Hydrologic Model Layer Surfaces" **raster** file
  
### USGS ME Topography Data 

USGS ME topography data was obtained through the following process: 

- Main page: https://www.usgs.gov/core-science-systems/national-geospatial-program/national-map
- Download and Selection page: https://viewer.nationalmap.gov/basic/?basemap=b1&category=ned,nedsrc&title=3DEP%20View
  - Steps: 
  - Create a box/narrow the view to your area of interest
  - 


## Attach Packages and Data 

```{r}
# Attach packages 

library(tidyverse)
library(here)
library(janitor)

# Disable scientific notation 

options(scipen=999)
```

```{r}
# Read in the full dataset for all well water measurements for the USA 

entire_usa_gw <- readr::read_tsv("entire_usgs_usa.txt")
```

## R Data Analysis 

### Refine dataset for the Mississippi Embayment 

```{r}
# Only keep well data for states in ME: 
# Missouri, Illinois, Kentucky, Tennessee, Arkansas, Mississippi, Alabama, Louisiana

me <- entire_usa_gw %>% 
  filter(state %in% c("alabama", "arkansas", "illinois", "kentucky", "louisiana", "missouri", "mississippi", "tennessee"))

# If-else statement to have either well_depth or hole_depth (OR) 
# Remove well depths of 0
# Remove wells that do not have a date associated with them 

me_usgs_gw <- me %>% 
  filter(!well_depth_va == "NA" | !hole_depth_va == "NA") %>% 
  filter(!well_depth_va == 0.00) %>% 
  filter(!lev_dt == "NA")


# Attempts at if-else type filtering 

# me_usgs_gw <- me %>% 
#   filter_at(vars(well_depth_va, hole_depth_va), all_vars(."NA"))
#   
#   filter(
#     if (well_depth_va == "NA") 
#       else hole_depth_va)

```


### Create experimental subset of data to try date constraint on (just Alabama)

```{r}
# Only keep alabama 

exp_sub <- me_usgs_gw %>% 
  filter(state == "alabama") 
  
```

```{r}
# Determine min/max dates of wells (unique wells) 
# Group by site_no and have minimum of 9 observations for each well 
# use summarise to find min and max date 

sub_minmax <- exp_sub %>% 
  group_by(site_no) %>% 
  filter(n() > 9) %>% 
  summarise(
    mindate = min(level_year), 
    maxdate = max(level_year)
  )

# Constrain by a range of 20 years 

sub_date <- sub_minmax %>% 
  filter(maxdate - mindate >= 20)

```

```{r}
# Make vector of unique site IDs that are constrained 

constrained_wells <- sub_date %>% 
  pull(site_no)

# Use the resulting vector to filter target sites from original dataframe 

final_alabama_wells <- exp_sub %>%
  filter(site_no %in% c(constrained_wells))
```


### Use above method on entire dataset 

```{r}
# Determine min/max dates of wells (unique wells) 
# Group by site_no and have minimum of 9 observations for each well 
# use summarise to find min and max date 

me_minmax <- me_usgs_gw %>%
  group_by(site_no) %>% 
  filter(n() > 9) %>% 
  summarise(
    mindate = min(level_year), 
    maxdate = max(level_year)
  )

# Constrain by a range of 20 years 

me_date <- me_minmax %>% 
  filter(maxdate - mindate >= 20)

# Make vector of unique site IDs that are constrained 

constrained_me_wells <- me_date %>% 
  pull(site_no)

# Use the resulting vector to filter target sites from original dataframe 

final_me_wells <- me_usgs_gw %>%
  filter(site_no %in% c(constrained_me_wells))

# Use just unique wells for location/ArcGIS purposes (added well and hole depth)

unique_me_wells <- final_me_wells %>% 
 distinct(site_no, .keep_all = TRUE) %>% 
  select(site_no, dec_lat_va, dec_long_va, well_depth_va, hole_depth_va, alt_va) 

# Test for ArcGIS issue (adding area column)

# unique_me_wells_2 <- final_me_wells %>% 
#  distinct(site_no, .keep_all = TRUE) %>% 
#   select(site_no, dec_lat_va, dec_long_va, well_depth_va, hole_depth_va) %>% 
#   mutate(area = "5")

# Add character value in front of site_no column as workaround for ArcGIS issue
# unique_me_wells$site_no <- sub("^", "x", unique_me_wells$site_no)

# Write to text file to then export to ArcGIS 

write_tsv(unique_me_wells, here::here("me_data", "unique_me_wells.txt"))

write_tsv(unique_me_wells, here::here("me_data", "unique_me_wells_2.txt"))
```

## ArcGIS Data Analysis 

The following steps were performed in ArcGIS: 

1. Import USGS ME geologic data (rasters) 
2. Import USGS wells (text file from analysis above) 
3. Use tool "Extract multi points to values" to determine well location intersection with geological raster layers 
4. Create polygon to outline ME 
5. Use "Intersect" tool to constrain wells to only fall within the ME 
6. Export resulting well data (with intersection from step 3) as a text file 

### Files from ArcGIS 

After processing data in ArcGIS, import resulting text file back into R for further analysis 

```{r}
# Read in file from ArcGIS 

me_wells_arc <- readr::read_csv(here::here("me_data", "mewellintersect.txt"))

```

```{r}
# Basic data tidying 
# clean names, remove extra columns, remove character from site ID column 

me_wells_arc_tidy <- me_wells_arc %>% 
  clean_names() %>% 
  select(-objectid, -fid_wellsme, -fid_mepoly)

me_wells_arc_tidy$site_no <- gsub("x", "", me_wells_arc_tidy$site_no)

```

