---
title: "For Loop Attempt USGS Data"
author: "Annette Hilton"
date: "11/6/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Goals and Steps 

1. Figure out how to write forloop and have the results (dataframes) for each state 
2. Figure out how to write these files to a csv or text file (or both) in the loop? 
3. Write a separate function to deal with all of the date stuff 
4. Write a separate function to merge all 53 state/territory files 

## Errors and areas to fix/improve 

- Dates and decimal dates, how to deal with impartial dates? Must return to this question. Consider: 
  - Making new column that contains the length of the string 
  - Look at dates or parse dates from "left of" or "mid of" 
- Figure out way to merge state data and keep separate (only state data, not giant dataframe with all 50 states) 

```{r}
# Attach packages

library(tidyverse)
library(here)
library(lubridate)

# Disable scientific notation 

options(scipen=999)

```
### For-loop on USA territory files 

Here I wrote a for-loop to perform the following: 

1. Read in raw text data files (two raw data files for each state) 
  a. Specifically assign columns as they are read in with the correct format (character, numeric, etc.)
  b. Attempt to assign dates 
2. Merge the two files for each state 
  a. Merge by site number
  b. Full merge so nothing is ommitted, even if there is not a match between the two data files 
  c. Remove columns that are not of interest, tidy the dataframe 
3. Pull the state name for each dataframe produced and return each state individually
  

```{r}
files <- list.files(path = (here::here("raw_data")))

state <- c("alabama", "alaska", "arizona", "arkansas", "california", "colorado", "connecticut", "delaware", "districtcolumbia", "florida", "georgia", "hawaii", "idaho", "illinois", "indiana", "iowa", "kansas", "kentucky", "louisiana", "maine", "maryland", "massachusetts", "michigan", "minnesota", "mississippi", "missouri", "montana", "nebraska", "nevada", "newhampshire", "newjersey", "newmexico", "newyork", "northcarolina", "northdakota", "oaklahoma", "ohio", "oregon", "pennsylvania", "puertorico", "rhodeisland", "southcarolina", "southdakota", "tennessee", "texas", "utah", "vermont", "virginia", "virginislands", "washington", "westvirginia", "wisconsin", "wyoming")
```



```{r}
#---------------------------------------------------------------------------------
# This is the for loop with the objectives described above
#---------------------------------------------------------------------------------


results <- data.frame(files = "state")

df.names <- paste(state, sep="")

for (i in 1:length(state)) {
  name = state[i]
  
  state_files = list.files(path = (here::here("raw_data")), 
                                   pattern = name)
  raw_import <- state_files[1]
  import <- state_files[2]
  
  raw_import_usgs <- read_tsv(here::here("raw_data", raw_import),
                              col_types = cols(
                                agency_cd = col_character(),
                                site_no = col_double(),
                                site_tp_cd = col_character(),
                                lev_dt = col_character(),
                                lev_tm = col_character(),
                                lev_tz_cd = col_character(), 
                                lev_va = col_double(), 
                                sl_lev_va = col_character(), 
                                sl_datum_cd = col_character(), 
                                lev_status_cd = col_character(),
                                lev_agency_cd = col_character(),
                                lev_dt_acy_cd = col_character(),
                                lev_acy_cd = col_character(), 
                                lev_src_cd = col_character(),
                                lev_meth_cd = col_character()
                                  
                                   )) 
 
  parse_date_time(raw_import_usgs$lev_dt, orders = c("ymd", "Y!", "Ym"))
  
  import_usgs <- read_tsv(here::here("raw_data", import),
                          col_types = cols(
                            agency_cd = col_character(),
                            site_no = col_double(),
                            station_nm = col_character(),
                            dec_lat_va = col_double(),
                            dec_long_va = col_double(),
                            coord_acy_cd = col_character(), 
                            dec_coord_datum_cd = col_character(),
                            alt_va = col_double(),
                            alt_acy_va = col_double(),
                            alt_datum_cd = col_character(),
                            well_depth_va = col_double(),
                            hole_depth_va = col_double()
                          ))

  state_files_merge <- full_join(x = import_usgs, y = raw_import_usgs, by = "site_no", copy = FALSE) 
  
  state_files_usgs <- state_files_merge %>% 
    select(-station_nm, -coord_acy_cd, -agency_cd.y, -site_tp_cd, -lev_tm, -sl_lev_va : -lev_age_cd) 

  results <- state_files_usgs

  assign(df.names[i], results)}

# write.table(results, file = "output.csv", row.names = FALSE, append = TRUE, col.names = TRUE, sep = ",")

    
    


# This is in-progress for figuring out how to write the resulting files to a text doc (below)

# file_name <- paste(name, ".txt", sep ="")
# 
# write_tsv(here::here("merged_state_data", file_name) 

```

Issues with the for loop working to mutate columns because of complications with the length/loop. Perhaps it would be better to do the date work as a separate function after the loop. (Write it as a function) Information/attempts below. 

```{r}

# Below: parse_date_time works on small example (alabama in usa_groundwater_data_import). I think it is not working here because something to do with the loop of the 50 states. "Error: Column `level_date` must be length 23296 (the number of rows) or one, not 72697) 
    
    
    # mutate(
    #   level_date = lubridate::parse_date_time(state_files_usgs$lev_dt, orders = c("ymd", "Y!", "Ym")))
  
   # level_date = lubridate::ymd(lev_dt),
   # level_decimal_date = lubridate::decimal_date(level_date),
   # level_dec_dt_full = case_when(
   #   !is.na(level_decimal_date) ~ level_decimal_date,
   #   is.na(level_decimal_date) ~ as.numeric(lev_dt) + 0.5),
   # level_date_new = lubridate::date_decimal(level_dec_dt_full),
   # level_month = lubridate::month(level_date_new, label = TRUE),
   # level_year = lubridate::year(level_date_new))
   # 
```

```{r}
  # 
  # state_files_usgs <- state_files_merge %>%
  #   select(-lev_tm, -sl_lev_va : -station_nm, -coord_acy_cd, -alt_acy_va) %>%
  #    mutate(
  #   level_date = lubridate::ymd(lev_dt),
  #   level_decimal_date = lubridate::decimal_date(level_date),
  #   level_dec_dt_full = case_when(
  #     !is.na(level_decimal_date) ~ level_decimal_date,
  #     is.na(level_decimal_date) ~ as.numeric(lev_dt) + 0.5),
  #   level_date_new = lubridate::date_decimal(level_dec_dt_full),
  #   level_month = lubridate::month(level_date_new, label = TRUE),
  #   level_year = lubridate::year(level_date_new))
```

